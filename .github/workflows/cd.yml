name: CD

on: workflow_dispatch

jobs:
  deployment:
    name: Deployment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Update psd and psm version
        shell: pwsh
        run: |
          $manifestPath = '${{ github.workspace }}/VenafiPS/VenafiPS.psd1'
          $modulePath = $manifestPath.Replace('.psd1', '.psm1')
          $manifest = Import-PowerShellDataFile '${{ github.workspace }}/VenafiPS/VenafiPS.psd1'
          [version]$version = $manifest.ModuleVersion
          [version]$newVersion = "{0}.{1}.{2}" -f $Version.Major, $Version.Minor, ($Version.Build + 1)
          Update-ModuleManifest -Path $manifestPath -ModuleVersion $newVersion
          ((Get-Content -Path $modulePath -Raw).Replace('((NEW_VERSION))', $newVersion)) | Set-Content -Path $modulePath
          "New version: $newVersion"
          # set version to be used in later steps
          "venafips_new_version=$newVersion" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Install platyPS module
        shell: pwsh
        run: |
          gci env:
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module platyPS -ErrorAction Stop
      - name: Update docs
        shell: pwsh
        run: |
          Remove-Module 'VenafiPS' -Force -ea SilentlyContinue -Verbose
          Import-Module '${{ github.workspace }}/VenafiPS/VenafiPS.psd1' -Force -Verbose

          #Build YAMLText starting with the header
          $YMLtext = (Get-Content "${{ github.workspace }}/header-mkdocs.yml") -join "`n"
          $YMLtext = "$YMLtext`n"
          $parameters = @{
              Path        = '${{ github.workspace }}/CHANGELOG.md'
              ErrorAction = 'SilentlyContinue'
          }
          $changeLogText = (Get-Content @parameters) -join "`n"
          if ($changeLogText) {
              $changeLogText | Set-Content "${{ github.workspace }}/docs/changelog.md"
              $YMLText = "$YMLtext  - Change Log: changelog.md`n"
          }

          $YMLText = "$YMLtext  - Functions:`n"
          # Drain the swamp
          $parameters = @{
              Recurse     = $true
              Force       = $true
              Path        = "${{ github.workspace }}/docs/functions"
              ErrorAction = 'SilentlyContinue'
          }
          $null = Remove-Item @parameters
          $Params = @{
              Path        = "${{ github.workspace }}/docs/functions"
              type        = 'directory'
              ErrorAction = 'SilentlyContinue'
          }
          $null = New-Item @Params
          $Params = @{
              Module       = 'VenafiPS'
              Force        = $true
              OutputFolder = '${{ github.workspace }}/docs/functions'
              NoMetadata   = $true
          }
          New-MarkdownHelp @Params | ForEach-Object {
              $Function = $_.Name -replace '\.md', ''
              $Part = "    - {0}: functions/{1}" -f $Function, $_.Name
              $YMLText = "{0}{1}`n" -f $YMLText, $Part
              $Part
          }
          $YMLtext | Set-Content -Path '${{ github.workspace }}/mkdocs.yml'
      - name: Update repo
        run: |
          git config --global user.name 'Greg Brownstein'
          git config --global user.email 'greg@jagtechnical.com'
          git add VenafiPS
          git add docs
          git add mkdocs.yml
          git status -v
          # git commit -m "Update manifest and docs to ${{ env.venafips_new_version }}"

          # git push
      - name: Generate file hash
        shell: pwsh
        run: |
          $fullPath = Resolve-Path ./VenafiPS | Select-Object -ExpandProperty Path
          Get-ChildItem -Path ./VenafiPS -File -Recurse | Get-FileHash -Algorithm SHA256 | Select-Object Hash,
          @{
          'n' = 'File'
          'e' = {
          $_.Path.Replace("$fullPath/", '')
          }
          } | ConvertTo-Json | Out-File -FilePath ../../hash.json
      - name: Upload hash.json artifact
        uses: actions/upload-artifact@v2
        with:
          name: hash.json
          path: /home/runner/work/hash.json
      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          files: /home/runner/work/hash.json
          tag_name: v${{ env.venafips_new_version }}
          body_path: ${{ github.workspace }}/RELEASE.md
          draft: true
      # - name: Publish
      #   env:
      #     NUGET_KEY: ${{ secrets.NUGET_KEY }}
      #   shell: pwsh
      #   run: |
      #     Publish-Module -Path "${{ github.workspace }}/VenafiPS" -NuGetApiKey $env:NUGET_KEY -Verbose